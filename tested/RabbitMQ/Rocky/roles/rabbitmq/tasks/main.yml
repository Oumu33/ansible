---
# RabbitMQ 部署任务 - 使用源码安装

- name: 安装编译依赖
  ansible.builtin.dnf:
    name:
      - gcc
      - gcc-c++
      - make
      - autoconf
      - ncurses-devel
      - openssl-devel
      - xz
      - socat
      - logrotate
    state: present
    update_cache: yes
  ignore_errors: yes
  register: dnf_result
  failed_when: false

- name: 复制 Erlang 源码包
  ansible.builtin.copy:
    src: /opt/ansible/downloads/otp_src_26.2.5.tar.gz
    dest: /tmp/otp_src_26.2.5.tar.gz
    mode: '0644'

- name: 复制 RabbitMQ 源码包
  ansible.builtin.copy:
    src: /opt/ansible/downloads/rabbitmq-server-generic-unix-3.13.7.tar.xz
    dest: /tmp/rabbitmq-server-generic-unix-3.13.7.tar.xz
    mode: '0644'

- name: 检查 Erlang 是否已安装
  ansible.builtin.stat:
    path: /usr/local/bin/erl
  register: erlang_installed

- name: 解压 Erlang 源码
  ansible.builtin.unarchive:
    src: /tmp/otp_src_26.2.5.tar.gz
    dest: /tmp
    remote_src: yes
  when: not erlang_installed.stat.exists

- name: 配置 Erlang
  ansible.builtin.command:
    cmd: ./configure --prefix=/usr/local --without-javac
    chdir: /tmp/otp_src_26.2.5
  when: not erlang_installed.stat.exists
  register: erlang_configure

- name: 编译 Erlang
  ansible.builtin.command:
    cmd: make -j{{ ansible_processor_vcpus }}
    chdir: /tmp/otp_src_26.2.5
  when: not erlang_installed.stat.exists
  register: erlang_make

- name: 安装 Erlang
  ansible.builtin.command:
    cmd: make install
    chdir: /tmp/otp_src_26.2.5
  when: not erlang_installed.stat.exists
  register: erlang_install

- name: 设置 PATH 环境变量
  ansible.builtin.copy:
    dest: /etc/profile.d/erlang.sh
    content: |
      export PATH=/usr/local/bin:$PATH
    mode: '0644'

- name: 创建 RabbitMQ 用户
  ansible.builtin.user:
    name: rabbitmq
    system: true
    shell: /bin/false
    home: /var/lib/rabbitmq
    create_home: false

- name: 创建必要的目录
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: rabbitmq
    group: rabbitmq
    mode: '0755'
  loop:
    - /var/lib/rabbitmq
    - /var/log/rabbitmq
    - /etc/rabbitmq
    - /usr/local/rabbitmq

- name: 检查 RabbitMQ 是否已安装
  ansible.builtin.stat:
    path: /usr/local/rabbitmq/sbin/rabbitmq-server
  register: rabbitmq_installed

- name: 解压 RabbitMQ
  ansible.builtin.unarchive:
    src: /tmp/rabbitmq-server-generic-unix-3.13.7.tar.xz
    dest: /usr/local
    remote_src: yes
  when: not rabbitmq_installed.stat.exists

- name: 移动 RabbitMQ 目录
  ansible.builtin.command:
    cmd: mv /usr/local/rabbitmq_server-3.13.7 /usr/local/rabbitmq
  when: not rabbitmq_installed.stat.exists
  ignore_errors: yes

- name: 设置 RabbitMQ 权限
  ansible.builtin.file:
    path: /usr/local/rabbitmq
    owner: rabbitmq
    group: rabbitmq
    recurse: yes

- name: 创建 RabbitMQ 符号链接
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: link
  loop:
    - { src: '/usr/local/rabbitmq/sbin/rabbitmq-server', dest: '/usr/local/bin/rabbitmq-server' }
    - { src: '/usr/local/rabbitmq/sbin/rabbitmqctl', dest: '/usr/local/bin/rabbitmqctl' }
    - { src: '/usr/local/rabbitmq/sbin/rabbitmq-plugins', dest: '/usr/local/bin/rabbitmq-plugins' }

- name: 生成 RabbitMQ 配置文件
  ansible.builtin.copy:
    dest: /etc/rabbitmq/rabbitmq.conf
    content: |
      listeners.tcp.default = 5672
      management.tcp.port = 15672
      loopback_users = none
      disk_free_limit.relative = 2.0
      vm_memory_high_watermark.relative = 0.6
    owner: rabbitmq
    group: rabbitmq
    mode: '0644'

- name: 生成 RabbitMQ 环境配置文件
  ansible.builtin.copy:
    dest: /etc/rabbitmq/rabbitmq-env.conf
    content: |
      RABBITMQ_NODENAME={{ rabbitmq_nodename }}
      RABBITMQ_LOGS=/var/log/rabbitmq
      RABBITMQ_MNESIA_BASE=/var/lib/rabbitmq
      RABBITMQ_ENABLED_PLUGINS_FILE=/etc/rabbitmq/enabled_plugins
    owner: rabbitmq
    group: rabbitmq
    mode: '0644'

- name: 设置 Erlang Cookie
  ansible.builtin.copy:
    content: "{{ rabbitmq_erlang_cookie }}"
    dest: /var/lib/rabbitmq/.erlang.cookie
    owner: rabbitmq
    group: rabbitmq
    mode: '0400'
    force: yes

- name: 启用管理插件
  ansible.builtin.copy:
    dest: /etc/rabbitmq/enabled_plugins
    content: |
      [rabbitmq_management].
    owner: rabbitmq
    group: rabbitmq
    mode: '0644'

- name: 启动 RabbitMQ 服务
  ansible.builtin.shell: |
    export PATH=/usr/local/bin:$PATH
    cd /usr/local/rabbitmq
    su - rabbitmq -s /bin/bash -c '/usr/local/rabbitmq/sbin/rabbitmq-server -detached'
  ignore_errors: yes

- name: 等待 RabbitMQ 启动
  ansible.builtin.wait_for:
    port: 5672
    delay: 10
    timeout: 120

- name: 添加管理员用户
  ansible.builtin.shell: |
    export PATH=/usr/local/bin:$PATH
    /usr/local/rabbitmq/sbin/rabbitmqctl add_user {{ rabbitmq_admin_user }} {{ rabbitmq_admin_password }}
  ignore_errors: yes
  changed_when: false

- name: 设置管理员权限
  ansible.builtin.shell: |
    export PATH=/usr/local/bin:$PATH
    /usr/local/rabbitmq/sbin/rabbitmqctl set_user_tags {{ rabbitmq_admin_user }} administrator
  ignore_errors: yes
  changed_when: false

- name: 设置管理员权限
  ansible.builtin.shell: |
    export PATH=/usr/local/bin:$PATH
    /usr/local/rabbitmq/sbin/rabbitmqctl set_permissions -p / {{ rabbitmq_admin_user }} '.*' '.*' '.*'
  ignore_errors: yes
  changed_when: false

- name: 配置集群（仅 master 节点）
  ansible.builtin.shell: |
    export PATH=/usr/local/bin:$PATH
    /usr/local/rabbitmq/sbin/rabbitmqctl stop_app
    /usr/local/rabbitmq/sbin/rabbitmqctl reset
    /usr/local/rabbitmq/sbin/rabbitmqctl start_app
  when: rabbitmq_node_type == 'master'
  ignore_errors: yes
  changed_when: false

- name: 加入集群（仅 slave 节点）
  ansible.builtin.shell: |
    export PATH=/usr/local/bin:$PATH
    /usr/local/rabbitmq/sbin/rabbitmqctl stop_app
    /usr/local/rabbitmq/sbin/rabbitmqctl reset
    /usr/local/rabbitmq/sbin/rabbitmqctl join_cluster {{ rabbitmq_cluster_nodes[0] }}
    /usr/local/rabbitmq/sbin/rabbitmqctl start_app
  when: rabbitmq_node_type == 'slave'
  ignore_errors: yes
  changed_when: false