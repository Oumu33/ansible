---
- name: 创建 alertmanager 用户
  ansible.builtin.user:
    name: "alertmanager"
    system: true
    shell: /bin/false
    home: "/usr/local/alertmanager"
    create_home: false
  become: true

- name: 创建必要的目录
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "alertmanager"
    group: "alertmanager"
    mode: '0755'
  loop:
    - "/usr/local/alertmanager"
    - "{{ alertmanager_data_path }}"
    - "{{ vm_config_dir }}/alertmanager"
    - "{{ alertmanager_log_path }}"
  become: true

- name: 从控制节点复制 alertmanager
  ansible.builtin.copy:
    src: /tmp/alertmanager-0.27.0.linux-amd64.tar.gz
    dest: /tmp/alertmanager.tar.gz
    mode: '0644'
  become: true

- name: 解压 alertmanager
  ansible.builtin.unarchive:
    src: /tmp/alertmanager.tar.gz
    dest: "/usr/local/alertmanager"
    remote_src: true
    extra_opts: ["--strip-components=1"]
    owner: "alertmanager"
    group: "alertmanager"
  become: true

- name: 生成 alertmanager 配置文件
  ansible.builtin.copy:
    dest: "{{ alertmanager_config_path }}"
    content: |
      # ============================================
      # Alertmanager 配置文件
      # ============================================
      # 说明：告警路由、分组、抑制规则配置
      # 作者：VictoriaMetrics-Full
      # 更新时间：2026-01-18
      # ============================================

      global:
        # 告警解决超时时间
        resolve_timeout: 5m
        # 告警发送超时时间
        http_config:
          timeout: 30s

      # ============================================
      # 告警路由配置
      # ============================================
      # 说明：定义告警如何分组、匹配和发送给不同的receiver
      # 路由是树状结构，从根路由开始匹配

      route:
        # 告警分组标签，相同标签的告警会被合并为一个通知
        group_by: ['alertname', 'severity', 'category', 'instance']
        # 等待时间：分组内第一个告警到达后等待的时间
        group_wait: 30s
        # 分组间隔：同一个分组内告警发送的间隔时间
        group_interval: 5m
        # 重复间隔：相同告警重复发送的间隔时间
        repeat_interval: 12h
        # 默认接收器
        receiver: 'default'

        # ============================================
        # 分层路由配置
        # ============================================

        # 按严重级别路由
        routes:
          # 严重级别告警：critical
          - match:
              severity: critical
            receiver: 'critical'
            group_wait: 10s
            repeat_interval: 5m
            continue: true

          # 警告级别告警：warning
          - match:
              severity: warning
            receiver: 'warning'
            group_wait: 30s
            repeat_interval: 2h
            continue: true

          # 信息级别告警：info
          - match:
              severity: info
            receiver: 'info'
            group_wait: 1m
            repeat_interval: 24h
            continue: true

          # 按类别路由：基础设施
          - match:
              category: infrastructure
            receiver: 'infrastructure'
            group_by: ['alertname', 'category']
            continue: true

          # 按类别路由：网络
          - match:
              category: network
            receiver: 'network'
            group_by: ['alertname', 'category', 'instance']
            continue: true

          # 按类别路由：资源
          - match:
              category: resource
            receiver: 'resource'
            group_by: ['alertname', 'category', 'instance']
            continue: true

          # 按类别路由：可用性
          - match:
              category: availability
            receiver: 'availability'
            group_by: ['alertname', 'category', 'instance']
            continue: true

          # 按类别路由：性能
          - match:
              category: performance
            receiver: 'performance'
            group_by: ['alertname', 'category', 'instance']
            continue: true

      # ============================================
      # 告警抑制规则
      # ============================================
      # 说明：定义告警之间的抑制关系，避免告警风暴

      inhibit_rules:
        # 主机宕机时，抑制该主机的所有其他告警
        - source_match:
            alertname: 'HostDown'
            severity: 'critical'
          target_match_re:
            alertname: '.*'
          equal: ['instance']

        # 严重级别告警抑制相同实例的警告级别告警
        - source_match:
            severity: 'critical'
          target_match:
            severity: 'warning'
          equal: ['alertname', 'instance']

        # CPU严重告警抑制内存警告告警（避免资源告警重复）
        - source_match:
            alertname: 'CriticalCPUUsage'
            severity: 'critical'
          target_match:
            alertname: 'HighMemoryUsage'
            severity: 'warning'
          equal: ['instance']

        # 磁盘严重告警抑制I/O警告告警
        - source_match:
            alertname: 'CriticalDiskUsage'
            severity: 'critical'
          target_match:
            alertname: 'HighDiskIOWait'
            severity: 'warning'
          equal: ['instance']

        # 交换机端口宕机抑制该端口的其他告警
        - source_match:
            alertname: 'SwitchPortDown'
            severity: 'warning'
          target_match_re:
            alertname: 'HighPortErrorRate|HighPortDiscardRate|HighPortUsage|HighBroadcastTraffic'
          equal: ['instance', 'ifName']

        # vmstorage宕机抑制该节点的其他VM告警
        - source_match:
            alertname: 'VMStorageDown'
            severity: 'critical'
          target_match_re:
            alertname: 'VMInsertDown|VMSelectDown|VMAuthDown|VMAlertDown'
          equal: ['instance']

      # ============================================
      # 接收器配置
      # ============================================
      # 说明：定义不同的通知方式和渠道
      # 注意：当前使用webhook作为示例，请根据实际需求修改

      receivers:
        # 默认接收器
        - name: 'default'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/'
              send_resolved: true
              http_config:
                timeout: 30s

        # 严重级别接收器
        - name: 'critical'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/critical'
              send_resolved: true
              http_config:
                timeout: 30s

        # 警告级别接收器
        - name: 'warning'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/warning'
              send_resolved: true
              http_config:
                timeout: 30s

        # 信息级别接收器
        - name: 'info'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/info'
              send_resolved: true
              http_config:
                timeout: 30s

        # 基础设施接收器
        - name: 'infrastructure'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/infrastructure'
              send_resolved: true
              http_config:
                timeout: 30s

        # 网络接收器
        - name: 'network'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/network'
              send_resolved: true
              http_config:
                timeout: 30s

        # 资源接收器
        - name: 'resource'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/resource'
              send_resolved: true
              http_config:
                timeout: 30s

        # 可用性接收器
        - name: 'availability'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/availability'
              send_resolved: true
              http_config:
                timeout: 30s

        # 性能接收器
        - name: 'performance'
          webhook_configs:
            - url: 'http://127.0.0.1:5001/performance'
              send_resolved: true
              http_config:
                timeout: 30s

      # ============================================
      # 模板配置（可选）
      # ============================================
      # 说明：自定义告警通知模板，可以美化通知内容

      # templates:
      #   - '/etc/alertmanager/templates/*.tmpl'
    owner: "alertmanager"
    group: "alertmanager"
    mode: '0644'
  become: true
  notify: restart alertmanager

- name: 创建 systemd 服务文件
  ansible.builtin.copy:
    dest: /etc/systemd/system/alertmanager.service
    content: |
      [Unit]
      Description=Alertmanager
      After=network.target

      [Service]
      Type=simple
      User=alertmanager
      Group=alertmanager
      WorkingDirectory=/usr/local/alertmanager
      ExecStart=/usr/local/alertmanager/alertmanager \
        --config.file={{ alertmanager_config_path }} \
        --storage.path={{ alertmanager_data_path }} \
        --web.listen-address={{ alertmanager_web_listen_address }}
      Restart=always
      RestartSec=5
      StandardOutput=journal
      StandardError=journal
      LimitNOFILE=65536

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  become: true
  notify: reload systemd

- name: 启动并启用 alertmanager 服务
  ansible.builtin.systemd:
    name: alertmanager
    state: "{{ service_state }}"
    enabled: "{{ service_enabled }}"
    daemon_reload: true
  become: true

- name: 清理临时文件
  ansible.builtin.file:
    path: /tmp/alertmanager.tar.gz
    state: absent
  become: true